{% extends "base.html" %}
{% block content %}

<div class="row g-4">

<!-- ================= LEFT PANEL ================= -->
<div class="col-lg-5 col-md-6">
<div class="glass-card p-4" style="max-height:85vh; overflow-y:auto;">

<h4 class="text-success mb-3">ğŸŒ± Smart Crop Prediction</h4>

<form action="/predict" method="POST">

<input type="number" step="any" name="nitrogen" class="form-control mb-2" placeholder="Nitrogen (N)" required>
<input type="number" step="any" name="phosphorus" class="form-control mb-2" placeholder="Phosphorus (P)" required>
<input type="number" step="any" name="potassium" class="form-control mb-2" placeholder="Potassium (K)" required>
<input type="number" step="any" name="temperature" class="form-control mb-2" placeholder="Temperature (Â°C)" required>
<input type="number" step="any" name="humidity" class="form-control mb-2" placeholder="Humidity (%)" required>
<input type="number" step="any" name="ph" class="form-control mb-2" placeholder="Soil pH" required>
<input type="number" step="any" name="rainfall" class="form-control mb-3" placeholder="Rainfall (mm)" required>

<button class="btn btn-modern w-100 mb-3">ğŸ” Predict Crop</button>
</form>

<hr>

<h5 class="mt-3">ğŸšœ Sell to APMC</h5>

<form action="/sell" method="POST">
<input name="crop" class="form-control mb-2" placeholder="Crop Name" required>
<input name="quantity" type="number" class="form-control mb-2" placeholder="Quantity (kg)" required>
<button class="btn btn-primary w-100">ğŸ“¤ Send to APMC</button>
</form>

</div>
</div>

<!-- ================= RIGHT PANEL ================= -->
<div class="col-lg-7 col-md-6">
<div class="glass-card p-4" style="max-height:85vh; overflow-y:auto;">

{% if result %}

<!-- Recommended Crop -->
<h4 class="text-success">ğŸ† Recommended Crop</h4>
<h2 class="fw-bold text-success">{{ result }}</h2>

{% if time_taken %}
<p class="text-muted">â± Prediction Time: {{ time_taken }} ms</p>
{% endif %}

<!-- Confidence -->
{% set best_prob = probabilities.values()|list|first %}
<h6>ğŸ’ AI Confidence Level</h6>
<div class="progress mb-4">
<div class="progress-bar bg-success"
     style="width: {{ best_prob }}%">
     {{ best_prob }}%
</div>
</div>

<!-- Crop Image -->
<div class="text-center mb-4">
<img src="{{ url_for('static', filename='crop_images/' + result + '.png') }}"
     class="img-fluid rounded shadow"
     style="max-height:180px;">
</div>

<hr>

<!-- Top 10 List -->
<h5 class="mb-3">ğŸ“Š Top 10 Crop Probabilities</h5>

{% set rank = 1 %}
{% for crop, prob in probabilities.items() %}
<div class="mb-3">

<div class="d-flex justify-content-between">
<span>
<strong>{{ rank }}. {{ crop }}</strong>
{% if rank == 1 %}
<span class="badge bg-success ms-2">Best Match</span>
{% endif %}
</span>
<span><strong>{{ prob }}%</strong></span>
</div>

<div class="progress">
<div class="progress-bar 
{% if rank == 1 %} bg-success
{% elif rank == 2 %} bg-primary
{% elif rank == 3 %} bg-warning
{% else %} bg-secondary
{% endif %}"
style="width: {{ prob }}%">
</div>
</div>

</div>
{% set rank = rank + 1 %}
{% endfor %}

<hr>

<!-- Chart -->
<h5 class="mt-4">ğŸ“ˆ Probability Chart</h5>
<canvas id="probChart" height="140"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
var ctx = document.getElementById("probChart").getContext("2d");

new Chart(ctx, {
    type: "bar",
    data: {
        labels: {{ probabilities.keys()|list|tojson }},
        datasets: [{
            label: "Probability (%)",
            data: {{ probabilities.values()|list|tojson }},
            backgroundColor: "rgba(40,167,69,0.8)"
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                max: 100
            }
        }
    }
});
</script>

{% else %}

<div class="text-center mt-5">
<h5 class="text-muted">ğŸŒ¾ No Recommendation Yet</h5>
<p>Enter soil parameters and click Predict</p>
</div>

{% endif %}

</div>
</div>

</div>

{% endblock %}